---
title: "Single-Cell Analysis Workflow of HCA Loom File test"
output:
  html_document: default
params:
  knitr_eval: FALSE
  fileId: "902ac276-d7bf-5ae2-b89d-f80096a0b310"
  sample: "donor_organism.biomaterial_core.biomaterial_id"
  core: 0
vignette: >
  %\VignetteIndexEntry{Single-Cell Analysis Workflow of HCA Loom File test}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8} 
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE, eval = params$knitr_eval)
```

This vignette follows single-cell analysis Workflow (workflow chapters of the “Orchestrating Single-Cell Analysis with Bioconductor” book) to analyze loom file from HCA dataset and tracks computing resources usage.

## Set up parameters

File id of loom file to analyze could be obtained using package `hca`, and one example shows below.

```{r, echo = TRUE, message=FALSE}
library(hca)
library(dplyr)
files(filters(
    projectTitle = list(is = "Census of Immune Cells"),
    organPart = list(is = "bone marrow"),
    fileFormat = list(is = "loom"),
    isIntermediate = list(is = FALSE))
)
```

```{r, echo = TRUE, message=FALSE, eval=TRUE}
fileId <- params$fileId
```

Column to analyze needs to be specified from colData of the dataset, potential targets could be donor_organism.biomaterial_core.biomaterial_id, cell_suspension.biomaterial_core.biomaterial_id, etc.

```{r, echo = TRUE, message=FALSE, eval=TRUE}
sample <- params$sample
```

```{r, echo = TRUE, message=FALSE, eval=TRUE}
fileId
sample
```

With two parameters set up, workflow could be started. 

## Start for `Rcollectl` and download loom file

```{r cl_start, echo = TRUE, message=FALSE}
library(Rcollectl)
library(hca)
library(dplyr)

## identify target loom file
myfile <- files(filters(fileId = list(is = fileId)))

## start Rcollectl
id <- cl_start(gsub('.loom', '', myfile$name))

## download file
loom_file <- files_download(myfile)
```

## Step data preparation 

```{r data_preparation, echo = TRUE, message=FALSE}
# record start time of each step
cl_timestamp(id, "data preparation")

## import loom file
library(LoomExperiment)
sce_loom <- LoomExperiment::import(loom_file, type = "SingleCellLoomExperiment")

## Using manifest data to annotate a .loom file
sce_loom <- optimus_loom_annotation(sce_loom)

## pre-process data
library(SingleCellExperiment)
sce_loom$sample <- colData(sce_loom)[, sample]

library(EnsDb.Hsapiens.v86)
rowData(sce_loom)$Chr <- mapIds(EnsDb.Hsapiens.v86, keys=substring(rowData(sce_loom)$ensembl_ids, 1, 15), column="SEQNAME", keytype="GENEID")

library(scater)
rownames(sce_loom) <- uniquifyFeatureNames(substring(rowData(sce_loom)$ensembl_ids, 1, 15), names = rowData(sce_loom)$Gene)

names(assays(sce_loom)) <- "counts"

saveRDS(sce_loom, file = "sce_loom.rds")
```

## Step quality control

```{r quality_control, message=FALSE}
cl_timestamp(id, "quality control")

library(BiocParallel)
library(scater)

if (params$core == 0) {
  core <- floor(parallel::detectCores()*.6)
} else {
  core <- params$core
}
core
bpp <- MulticoreParam(core)

sce_loom <- unfiltered <- addPerCellQC(sce_loom, BPPARAM=bpp, subsets=list(Mito=which(rowData(sce_loom)$Chr=="MT")))
```

## Stop `Rcollectl`

```{r cl_stop}
cl_stop(id)
```

## Plot collectl result

```{r plot_all}
path <- cl_result_path(id)
plot_usage(cl_parse(path))
```

## Plot collectl result with time stamp

```{r plot_timestamp}
path <- cl_result_path(id)
plot_usage(cl_parse(path)) +
  cl_timestamp_layer(path) +
  cl_timestamp_label(path) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

## `R` session information

```{r session_info, echo=FALSE}
## Session info
library("sessioninfo")
options(width = 120)
session_info()
```
